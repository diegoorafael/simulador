<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Matem√°tica do Carro | Diego</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #00ff88; --bg: #ffffff; --card: #f5f7f9; --text: #1a1d21; --red: #ff3b30; --grey: #8e8e93; }
        @media (prefers-color-scheme: dark) {
            :root { --bg: #000000; --card: #1c1c1e; --text: #ffffff; --grey: #a1a1aa; }
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; padding: 20px; }
        
        .app-container { max-width: 450px; margin: 0 auto; }
        
        .header { text-align: left; margin-bottom: 30px; }
        .header h1 { font-size: 28px; font-weight: 900; margin: 0; letter-spacing: -1.5px; }
        .header span { color: var(--primary); font-size: 14px; font-weight: 500; }

        .market-info { display: flex; gap: 15px; margin-bottom: 25px; font-size: 12px; color: var(--grey); font-weight: 500; }
        .market-info b { color: var(--text); }

        .card { background: var(--card); border-radius: 20px; padding: 22px; margin-bottom: 20px; border: 1px solid rgba(128,128,128,0.1); }
        .card-label { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--grey); letter-spacing: 0.5px; margin-bottom: 15px; display: block; }

        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; font-size: 12px; margin-bottom: 8px; font-weight: 500; }
        
        select, input { 
            width: 100%; background: transparent; border: none; border-bottom: 2px solid rgba(128,128,128,0.2);
            padding: 10px 0; color: var(--text); font-size: 18px; font-weight: 600; transition: 0.3s;
        }
        select:focus, input:focus { border-color: var(--primary); }

        .sobra-display { text-align: center; padding: 10px 0; }
        .sobra-amt { font-size: 32px; font-weight: 900; color: var(--primary); letter-spacing: -1px; }
        .sobra-desc { font-size: 12px; color: var(--grey); margin-top: 5px; }

        .costs-detail { margin-top: 15px; border-top: 1px solid rgba(128,128,128,0.1); padding-top: 15px; }
        .cost-row { display: flex; justify-content: space-between; font-size: 13px; padding: 5px 0; }
        .cost-row span:last-child { font-weight: 600; color: var(--red); }

        .chart-wrap { height: 200px; margin: 20px 0; }

        .res-comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .res-item { text-align: center; }
        .res-val { font-size: 18px; font-weight: 800; display: block; }
        .res-tag { font-size: 10px; font-weight: 700; color: var(--grey); text-transform: uppercase; }

        .btn-main { 
            background: var(--text); color: var(--bg); border: none; width: 100%; 
            padding: 20px; border-radius: 18px; font-weight: 700; font-size: 16px;
            margin-top: 25px; transition: 0.3s; cursor: pointer;
        }
        .btn-main:active { transform: scale(0.98); opacity: 0.8; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <h1>Matem√°tica do Carro<span>.</span></h1>
        <span>Consultoria por Diego</span>
    </div>

    <div class="market-info">
        <span>Selic: <b id="selicVal">12.75%</b></span>
        <span>IPCA: <b>4.5%</b></span>
    </div>

    <div class="card">
        <span class="card-label">Par√¢metros</span>
        <div class="input-group">
            <label>Modelo de Refer√™ncia</label>
            <select id="preset" onchange="aplicar()">
                <option value="tcross" data-fipe="165000" data-perc="2.15" selected>VW T-Cross Comfort</option>
                <option value="polo" data-fipe="125000" data-perc="2.2">VW Polo Highline</option>
                <option value="compass" data-fipe="225000" data-perc="2.35">Jeep Compass Limited</option>
                <option value="hilux" data-fipe="330000" data-perc="2.6">Toyota Hilux SRX</option>
            </select>
        </div>
        <div class="input-group">
            <label>Valor Tabela FIPE</label>
            <input type="text" id="fipe" oninput="mask(this); calc()">
        </div>
    </div>

    <div class="card">
        <span class="card-label">Diferen√ßa Mensal</span>
        <div class="sobra-display">
            <div id="v-sobra" class="sobra-amt">R$ 0,00</div>
            <div class="sobra-desc">Capital liberado para investimento mensal</div>
        </div>
        
        <div class="costs-detail">
            <div class="cost-row"><span>Custo Real de Posse</span><span id="c-compra">R$ 0,00</span></div>
            <div class="cost-row"><span>Custo de Assinatura</span><span id="c-assin" style="color:var(--primary)!important">R$ 0,00</span></div>
        </div>
    </div>

    <div class="card">
        <span class="card-label">Patrim√¥nio (36 meses)</span>
        <div class="chart-wrap"><canvas id="grafico"></canvas></div>
        <div class="res-comparison">
            <div class="res-item">
                <span class="res-tag">Em Lata (Carro)</span>
                <span id="v-final-c" class="res-val" style="color:var(--red)">R$ 0,00</span>
            </div>
            <div class="res-item">
                <span class="res-tag">Em Dinheiro (Banco)</span>
                <span id="v-final-a" class="res-val" style="color:var(--primary)">R$ 0,00</span>
            </div>
        </div>
    </div>

    <button class="btn-main" onclick="gerarWhatsApp()">Enviar Relat√≥rio Detalhado</button>
</div>

<script>
let selic = 12.75;
let chart;

async function loadMarket() {
    try {
        const s = await fetch('https://api.bcb.gov.br/dados/serie/bcdata.sgs.11/dados/ultimos/1?formato=json').then(r => r.json());
        selic = ((Math.pow((parseFloat(s[0].valor)/100) + 1, 252) - 1) * 100).toFixed(2);
        document.getElementById('selicVal').innerText = selic + '%';
    } catch(e) {}
    calc();
}

function aplicar() {
    const s = document.getElementById('preset');
    const o = s.options[s.selectedIndex];
    document.getElementById('fipe').value = parseFloat(o.dataset.fipe).toLocaleString('pt-BR', {minimumFractionDigits:2});
    calc();
}

function mask(i) {
    let v = i.value.replace(/\D/g,'');
    v = (v/100).toFixed(2) + '';
    v = v.replace(".",",").replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
    i.value = v;
}

function parse(v) { return parseFloat(v.toString().replace(/\./g,'').replace(',','.').replace('R$','').trim()) || 0; }

function calc() {
    const fipe = parse(document.getElementById('fipe').value);
    const n = 36;
    const j = 0.0145;
    const e = fipe * 0.3;
    const sel = document.getElementById('preset');
    const assin = fipe * (parseFloat(sel.options[sel.selectedIndex].dataset.perc)/100);

    const ipvaM = (fipe * 0.04) / 12;
    const segM = (fipe * 0.035) / 12;
    const manM = (fipe * 0.015) / 12;
    const parc = (fipe - e) * (j * Math.pow(1+j, n)) / (Math.pow(1+j, n) - 1);
    
    const custoC = parc + ipvaM + segM + manM;
    const sobra = custoC - assin;

    document.getElementById('c-compra').innerText = custoC.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
    document.getElementById('c-assin').innerText = assin.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
    document.getElementById('v-sobra').innerText = sobra.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

    const sm = Math.pow(1 + (selic/100), 1/12) - 1;
    let capAss = e, labs = [], dAss = [], dCom = [];
    
    for(let i=0; i<=n; i++) {
        labs.push(i+"m");
        let vCarro = fipe * Math.pow(0.88, i/12);
        let sd = (fipe - e) * (Math.pow(1+j, n) - Math.pow(1+j, i)) / (Math.pow(1+j, n) - 1);
        dCom.push(Math.max(0, vCarro - (i === n ? 0 : sd)));
        if(i > 0) capAss = capAss * (1 + sm) + sobra;
        dAss.push(capAss);
    }

    document.getElementById('v-final-c').innerText = dCom[n].toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
    document.getElementById('v-final-a').innerText = dAss[n].toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

    if (chart) chart.destroy();
    chart = new Chart(document.getElementById('grafico').getContext('2d'), {
        type: 'line',
        data: { labels: labs, datasets: [
            { label: 'Investimento', data: dAss, borderColor: '#00ff88', borderWidth: 4, pointRadius: 0, tension: 0.4 },
            { label: 'Desvaloriza√ß√£o', data: dCom, borderColor: '#ff3b30', borderWidth: 2, borderDash: [5,5], pointRadius: 0, tension: 0.4 }
        ]},
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } }
    });
}

function gerarWhatsApp() {
    const diff = parse(document.getElementById('v-final-a').innerText) - parse(document.getElementById('v-final-c').innerText);
    const msg = `*üìä MATEM√ÅTICA DO CARRO*\n` +
        `Sobra Mensal Investida: ${document.getElementById('v-sobra').innerText}\n` +
        `Vantagem no Final: +${diff.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}\n` +
        `_Consultoria por @matematicadocarro_`;
    window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`, '_blank');
}
window.onload = () => { loadMarket(); aplicar(); };
</script>
</body>
</html>
